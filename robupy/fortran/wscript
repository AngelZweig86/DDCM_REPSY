#!/usr/bin/env python

# standard library
import shutil
import glob
import os

# WAF system
from waflib.Task import Task

''' Task Generators
'''


class CreateDirectoryStructure(Task):

    def run(self):

        os.chdir(self.env.project_paths['ROBUPY'] + '/fortran')

        for dir_ in ['include', 'lib', 'bin']:
            try:
                os.makedirs(dir_)
            except OSError:
                pass

            try:
                os.remove(dir_)
            except OSError:
                pass


class CreateRobufortLibrary(Task):

    after = ['CreateDirectoryStructure']

    def run(self):

        # Determine compiler options
        compiler_options = '-O3 -fpic'

        files = ['robufort_program_constants.f90', 'robufort_auxiliary.f90',
                 'robufort_slsqp.f90', 'robufort_development.f90',
                 'robufort_core.f90']

        for file_ in files:
            os.system('gfortran ' + compiler_options + ' -c ' + file_)

        os.system('gfortran ' + compiler_options + ' --fixed-form -c original_slsqp.f')

        os.system('ar crs libfort_robufort.a *.o *.mod')

        os.chdir(self.env.project_paths['ROBUPY'] + '/fortran')

        module_files = glob.glob('*.mod')
        for file_ in module_files:
            shutil.move(file_, 'include/')

        shutil.move('libfort_robufort.a', 'lib/')


class CreateRobufortExecutable(Task):

    after = ['CreateRobufortLibrary']

    def run(self):

        is_debug = self.is_debug

        from fortran.build_robufort import robufort_build

        robufort_build(self, is_debug)


class CreateF2pyInterface(Task):

    after = ['CreateRobufortExecutable_debug']

    def run(self):

        os.chdir(self.env.project_paths['ROBUPY'] + '/python/f2py')

        # Link to original library
        for dir_ in ['include', 'lib']:
            try:
                os.remove(dir_)
            except OSError:
                pass

            try:
                shutil.rmtree(dir_)
            except OSError:
                pass

            os.symlink('../../fortran/' + dir_, dir_)

        os.system(
            'f2py3 -c -m  f2py_core f2py_interface_core.f90 -Iinclude -Llib '
            '-lfort_robufort')

        os.system(
            'f2py3 -c -m  f2py_debug f2py_interface_debug.f90 -Iinclude -Llib '
            '-lfort_robufort')

''' Build
'''


def build(bld):

    # Distribute class attributes
    is_debug = bld.options.debug

    # Initialize directory structure
    task_1 = CreateDirectoryStructure(env=bld.env)

    bld.add_to_group(task_1)

    # Create the ROBUFORT library. This is build in addition to the ROBUFORT
    # executable to allow for the use of an F2PY interface to the core
    # functions as well.
    task_2 = CreateRobufortLibrary(env=bld.env)

    bld.add_to_group(task_2)

    task_2.set_run_after(task_1)

    # Create the ROBUFORT executable
    task_3 = CreateRobufortExecutable(env=bld.env)

    task_3.is_debug = is_debug

    bld.add_to_group(task_3)

    task_3.set_run_after(task_2)

    # Build F2PY interface
    task_4 = CreateF2pyInterface(env=bld.env)

    bld.add_to_group(task_4)

    task_4.set_run_after(task_3)

