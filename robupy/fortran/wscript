#!/usr/bin/env python

# standard library
import shutil
import glob
import os

# WAF system
from waflib.Task import Task

''' Task Generators
'''


class CreateDirectoryStructure(Task):

    def run(self):

        os.chdir(self.env.project_paths['ROBUPY'] + '/fortran')

        for dir_ in ['include', 'lib', 'bin']:
            try:
                os.makedirs(dir_)
            except OSError:
                pass

            try:
                os.remove(dir_)
            except OSError:
                pass


class CreateRobufortLibrary(Task):

    def run(self):

        # Determine compiler options
        compiler_options = '-O3 -fpic'

        files = ['robufort_constants.f90', 'robufort_auxiliary.f90',
                 'robufort_slsqp.f', 'solve_emax.f90', 'solve_risk.f90',
                 'solve_ambiguity.f90', 'robufort_library.f90',
                 'robufort_testing.f90']

        for file_ in files:
            os.system('gfortran ' + compiler_options + ' -c ' + file_)

        os.system('ar crs libfort_robufort.a *.o *.mod')

        os.chdir(self.env.project_paths['ROBUPY'] + '/fortran')

        module_files = glob.glob('*.mod')
        for file_ in module_files:
            shutil.move(file_, 'include/')

        shutil.move('libfort_robufort.a', 'lib/')


class CreateRobufortExecutable(Task):

    def run(self):

        is_debug = self.is_debug

        from fortran.build_robufort import robufort_build

        robufort_build(self, is_debug)


class CreateF2pyInterfaces(Task):

    def run(self):

        os.chdir(self.env.project_paths['ROBUPY'] + '/fortran')

        os.system(
            'f2py3 -c -m  f2py_library f2py_interface_library.f90 '
            '-Iinclude -Llib -lfort_robufort -L/usr/lib/lapack -llapack')

        os.system(
            'f2py3 -c -m  f2py_debug f2py_interface_debug.f90 '
            '-Iinclude -Llib -lfort_robufort -L/usr/lib/lapack -llapack')

        os.system(
            'f2py3 -c -m  f2py_testing f2py_interface_testing.f90 '
            '-Iinclude -Llib -lfort_robufort -L/usr/lib/lapack -llapack')


class CreateKeaneWolpinExecutables(Task):

    def run(self):

        os.system(' gfortran -fcheck=bounds -o kw_dp3asim kw_dp3asim.f95')

        shutil.move('kw_dp3asim', 'bin/')

''' Build
'''


def build(bld):

    # Distribute class attributes
    is_debug = bld.options.is_debug

    # Initialize directory structure
    task_1 = CreateDirectoryStructure(env=bld.env)

    bld.add_to_group(task_1)

    # Create the ROBUFORT library. This is build in addition to the ROBUFORT
    # executable to allow for the use of an F2PY interface to the core
    # functions as well.
    task_2 = CreateRobufortLibrary(env=bld.env)

    bld.add_to_group(task_2)

    task_2.set_run_after(task_1)

    # Create the ROBUFORT executable
    task_3 = CreateRobufortExecutable(env=bld.env)

    task_3.is_debug = is_debug

    bld.add_to_group(task_3)

    task_3.set_run_after(task_2)

    # Build F2PY interface
    task_4 = CreateF2pyInterfaces(env=bld.env)

    bld.add_to_group(task_4)

    task_4.set_run_after(task_3)

    # Create the executables for the Keane & Wolpin (1994) comparisons.
    task_5 = CreateKeaneWolpinExecutables(env=bld.env)

    bld.add_to_group(task_5)

    task_5.set_run_after(task_4)